PulseApp.Templates.Catalog=['<div id="catalog-clear"><div id="catalog-clear-header"></div></div>','<div id="catalog_container">','<div id="reading-header">','<div id="reading-header-content">','<div id="back_button" class="reading-header-button"><i class="icon-closethin white"></i></div>','<h2 class="topbar_title">Add New Content to Pulse</h2>',"</div>","</div>",'<div id="catalog-content" class="abs">','<div class="throbber abs"></div>',"</div>","</div>","</div>"].join("");PulseApp.Templates.CatalogNav=['<div id="catalog-search-container" class="fix">','<input type="text" id="catalog-search" class="border-box abs" />',"</div>",'<div id="catalog-navigation-container" class="abs">','<ul id="catalog_navigation"></ul>',"</div>",'<div id="catalog-navigation-mobile-toggle"><i class="icon-rightthin"></i></div>'].join("");PulseApp.Templates.CatalogNavItem='<a href="javascript:if(PulseApp.Environment.isLoggedInUser()) {PulseApp.RouterObject.navigate(\'catalog/<%= encodeURIComponent(escape(title)).toLowerCase() %>\',{trigger: false, replace: true})}" class="navigation_item <%if(is_selected){%>highlight<%}%>"><%= title %><div class="catalog-subcategories-expander"><i class="icon-rightthin"></i></div></a><ul class="subcategories"></ul>';PulseApp.Templates.CatalogNavItemNested='<a href="javascript:if(PulseApp.Environment.isLoggedInUser()) {PulseApp.RouterObject.navigate(\'catalog/<%= encodeURIComponent(collections).toLowerCase() %>/<%= encodeURIComponent(title).toLowerCase() %>\',{trigger: false, replace: true})}" class="nested_item"><%= title %></a>';PulseApp.Templates.CatalogMain='<div id="catalog-category-header" class="fix"><h2><%= data.title %></h2></div><div id="catalog-items-container" class="border-box"></div>';PulseApp.Templates.CatalogFeaturedItem=['<div class="featured-tile">','<img src="<%= data.image_url %>" />','<div class="add-button <% if(data.is_added){ %> added<% } %>"></div>','<div class="featured-overlay abs">',"<h2><%= data.domain %></h2>","<p><%= data.short_description %></p>","<div>","</div>",].join("");PulseApp.Templates.CatalogListItem=['<div class="item-content">','<div class="publisher-logo-container rel">','<div class="publisher-logo placeholder large abs"></div>',"<% if(data.external_icon_url){ %>",'<div class="external-icon-container abs">','<div class="shift-left rel">','<img class="shift-right rel external-icon" src="<%= data.external_icon_url %>" />',"</div>","</div>",'<% } else if (data.image_url && data.image_url.indexOf("undefined") == -1){ %>','<img class="publisher-logo placeholder large abs" src="<%= data.image_url %>" />',"<% } %>","</div>",'<div class="item-detail">','<h4 class="name"><%= data.title %></h4>','<p class="description"><%= data.short_description || PulseApp.Helpers.truncateWithEllipsis(data.description, 75) %></p>',"</div>",'<div class="add-button <% if(data.is_added){ %> added<% } %>"></div>',"</div>"].join("");PulseApp.Templates.CatalogLocationInput=['<div class="location-form">','<div class="intro-text">Enter your city, state or zipcode to get local sources</div>','<input type="text" id="location-text">','<input type="button" id="submit-location" value="Submit">',"</div>"].join("");PulseApp.Views.Catalog=Backbone.View.extend({parent:$("#reader_container"),id:"catalog_parent",className:"abs",events:{"keyup #catalog-search":"triggerSearch","click #back_button":"goBack","click #catalog-clear":"goBack","click #catalog-navigation-mobile-toggle":"toggleMobileDropdown","click #catalog_navigation li":"closeMobileDropdown"},subViews:{header:{},nav:{},main:{},catalogSearch:{},serviceSearchResults:[]},template:_.template(PulseApp.Templates.Catalog),initialize:function(b,a){_.bindAll(this,"logKey","fireCatalogServiceSearch","searchComplete","triggerSearch","remove");$(document).bind("keyup",this.logKey);this.throttleSearch=null;this.model.collection.clearSelected();this.model.set({is_selected:true},{silent:true})},render:function(){var a=this;this.$el.append(this.template);this.subViews.nav=new PulseApp.Views.CatalogNav({collection:PulseApp.Catalog},{parentView:this});this.subViews.main=new PulseApp.Views.CatalogMain({model:this.model},{parentView:this});this.$el.find("#catalog-content").append(this.subViews.nav.$el).append(this.subViews.main.$el);this.parent.append(this.$el);setTimeout(function(){a.$el.addClass("open")},10);return this},goBack:function(){this.$el.removeClass("open");$(document).unbind("keyup",this.logKey);PulseApp.UserPages.forceSync(true);Backbone.history.options.root=Backbone.history.options.old_root;PulseApp.RouterObject.navigate(Backbone.history.old_fragment,{trigger:true})},triggerSearch:function(c){var b=this,a=c;if(this.throttleSearch!=null){clearTimeout(b.throttleSearch)}this.throttleSearch=setTimeout(function(){b.fireSearch(a)},350)},fireSearch:function(b){this.throttleSearch=null;var c=$("#catalog-category-header"),d=$("#catalog-items-container"),a=this.$el.find(".throbber");if(typeof this.subViews.catalogSearch.$el!=="undefined"){this.subViews.catalogSearch.remove()}if(_.isBlank(b.target.value)){c.show();d.show();$(a).hide()}else{this.subViews.catalogSearch=new PulseApp.Views.CatalogSearch({collection:new PulseApp.Collections.CatalogSearch(),parentView:this});c.hide();d.hide();$(a).show();this.subViews.catalogSearch.updateKeyword(b.target.value)}},fireCatalogServiceSearch:function(b){var a=b.keyword,c;if(PulseApp.Catalog.SupportedSearchTypes){c=(PulseApp.Catalog.SupportedSearchTypes.length-1);PulseApp.ServiceSearchFeedArray=[];_.each(PulseApp.Catalog.SupportedSearchTypes,function(g,e,f){var d=e==c?true:false;this.subViews.serviceSearchResults[e]=new PulseApp.Views.CatalogServiceSearch({collection:new PulseApp.Collections.CatalogServiceSearch({service_type:g,keyword:a}),isLastCollection:d,parentView:this})},this)}},searchComplete:function(){var a,b;a=this.subViews.catalogSearch.collection.search_results_collection.length,b=_.find(this.subViews.serviceSearchResults,function(c){return c.collection.length},this);if(!a&&!b){this.subViews.catalogSearch.$el.append('<div id="no-results" class="abs">No Results Found :(</div>')}},toggleMobileDropdown:function(a){if(PulseApp.isMobile){$("#catalog_container").addClass("mobile-showdropdown");$("#catalog_navigation").css({top:0})}},closeMobileDropdown:function(d){if(PulseApp.isMobile){if($(d.srcElement).hasClass("catalog-subcategories-expander")||$(d.srcElement).parent().hasClass("catalog-subcategories-expander")){return false}var b=$(d.srcElement).parent();var f=b.hasClass("category");var a=b.index();var c=a;if(!f){c+=(b.parent().index()+1)}$("#catalog-navigation-container").scrollTop(0);$("#catalog_navigation").css({top:c*-55});$("#catalog_container").removeClass("mobile-showdropdown");return false}},refreshNav:function(){this.subViews.nav.remove();this.subViews.nav=new PulseApp.Views.CatalogNav({collection:PulseApp.Catalog},{parentView:this});this.$el.find("#catalog-content").append(this.subViews.nav.$el)},logKey:function(a){if(a.keyCode===27){this.goBack()}}});PulseApp.Views.CatalogNav=Backbone.View.extend({id:"catalog-left",className:"abs",template:function(){return _.template(PulseApp.Templates.CatalogNav,{})},initialize:function(b,a){if(a){if(a.parentView){this.parentView=a.parentView}}this.collection.bind("reset",this.render,this);this.collection.bind("change:is_selected",this.setActiveCategory,this);this.render()},render:function(){this.$el.append(this.template());var a=this.$el.find("ul#catalog_navigation");_.each(this.collection.models,function(b){var c=b.get("title"),d=b.hidden_collections;if($.inArray(c,d)===-1){a.append(new PulseApp.Views.CatalogNavItem({model:b},{parentView:this.parentView}).$el)}},this);$(this.parent).append(this.$el);return this}});PulseApp.Views.CatalogNavItem=Backbone.View.extend({tagName:"li",className:"category border-box",template:_.template(PulseApp.Templates.CatalogNavItem),events:{"click .navigation_item":"categoryClick"},initialize:function(b,a){this.model.bind("change:is_selected",this.updateSelection,this);if(a){if(a.parentView){this.parentView=a.parentView}}this.render()},render:function(){var a=[];this.$el.append(this.template(this.model.toJSON()));if(this.model.items){_.each(this.model.items.models,function(b){if(b.get("is_collection")){a.push(b)}},this)}if(a.length!=0){this.$el.addClass("expandable");_.each(a,function(b){var c=b.get("title"),d=b.hidden_collections;if($.inArray(c,d)===-1){$(this.$el.find("ul")[0]).append(new PulseApp.Views.CatalogNavItemNested({model:b},{parentView:this.parentView}).$el)}},this)}return this},categoryClick:function(a){if(this.parentView.subViews.main!=undefined){this.parentView.subViews.main.remove()}this.parentView.subViews.main=new PulseApp.Views.CatalogMain({model:this.model},{parentView:this.parentView});$("#catalog-content").append(this.parentView.subViews.main.$el);this.model.collection.clearSelected();this.model.toggleSelected();this.toggleCatalogMenu();PulseApp.ActiveCatalogCategory=this},toggleCatalogMenu:function(){if(this.$el.hasClass("open")){this.$el.find("ul").slideUp("swing");this.$el.removeClass("open")}else{$(".category.open ul").slideUp("swing");$(".category").removeClass("open");if(this.$el.hasClass("expandable")){this.$el.find("ul").slideDown("swing");this.$el.addClass("open")}}},updateSelection:function(){$(".navigation_item").removeClass("highlight");this.$el.find("a").addClass("highlight")}});PulseApp.Views.CatalogNavItemNested=Backbone.View.extend({tagName:"li",template:_.template(PulseApp.Templates.CatalogNavItemNested),events:{"click .nested_item":"subCategoryClick"},initialize:function(b,a){if(a){if(a.parentView){this.parentView=a.parentView}}this.render()},render:function(){this.$el.append(this.template(this.model.toJSON()));return this},subCategoryClick:function(){if(this.parentView.subViews.main!=undefined){this.parentView.subViews.main.remove()}this.parentView.subViews.main=new PulseApp.Views.CatalogMain({model:this.model},{parentView:this.parentView});$("#catalog-content").append(this.parentView.subViews.main.$el)}});PulseApp.Views.CatalogMain=Backbone.View.extend({parent:$("#catalog-container"),id:"catalog-right",className:"abs",template:function(a){return _.template(PulseApp.Templates.CatalogMain,{data:a})},subViews:{category_header:{},items:{}},initialize:function(b,a){if(a){if(a.parentView){this.parentView=a.parentView}}this.render()},render:function(){var a=this;if(this.model.items.length===0){new PulseApp.Views.CatalogSpecialCategory({model:this.model},{parent:a})}else{return this.renderContent()}},renderContent:function(){this.$el.append(this.template(this.model.toJSON()));var a=this;this.subViews.items=new PulseApp.Views.CatalogItems({model:this.model,parent:a});this.$el.find("#catalog-items-container").append(this.subViews.items.$el);this.parent.append(this.$el);return this}});PulseApp.Views.CatalogSpecialCategory=Backbone.View.extend({id:"catalog-right",className:"abs",initialize:function(b,a){if(a){if(a.parent){this.parentView=a.parent}}this.model.bind("change:is_loaded",this.render,this);if(this.model.get("domain").toLowerCase()==="local"){if(navigator.geolocation){var c=this;navigator.geolocation.getCurrentPosition(function(d){c.model.set({lat:d.coords.latitude,"long":d.coords.longitude},{silent:true})})}}this.model.fetch()},render:function(){$("#catalog-content").append(this.parentView.renderContent().$el);this.parentView.parentView.refreshNav()}});PulseApp.Views.CatalogItems=Backbone.View.extend({tagName:"ul",id:"catalog_items",className:"rel clear",initialize:function(){this.render()},render:function(){_.each(this.model.items.models,function(c,a){var b=c.get("title"),d=c.hidden_collections;if($.inArray(b,d)===-1){if(c.get("is_collection")===undefined||c.get("is_collection")===false){this.$el.append(new PulseApp.Views.CatalogItem({model:c}).$el)}}},this);return this}});PulseApp.Views.CatalogItem=Backbone.View.extend({tagName:"li",className:"catalog_item",events:{"click .add-button":"addSource","click .name":"trackNameClick","click img":"trackImageClick"},template:function(a){return _.template(PulseApp.Templates.CatalogListItem,{data:a})},initialize:function(){this.render()},render:function(){this.$el.append(this.template(this.model.toJSON()));return this},addSource:function(c){if(PulseApp.Environment.isLoggedInUser()){var a,b=this;_gaq.push(["_trackEvent","Catalog_View","add_source"]);if(this.model.get("is_added")){return}else{a=new PulseApp.Views.AddPagePopUp({model:PulseApp.UserPages.models},{catalogItem:this.model,addButton:c.target,type:"category"});this.$el.append(a.$el);setTimeout(function(){b.$el.find("#popup").addClass("loaded")},10);return this}}else{PulseApp.Helpers.createSignUpModal("Read "+this.model.get("domain"),"Sign up easily to add your favorite sources.","add_source")}},trackNameClick:function(){_gaq.push(["_trackEvent","Catalog_View","item_name_click"])},trackImageClick:function(){_gaq.push(["_trackEvent","Catalog_View","item_image_click"])}});PulseApp.Views.AddPagePopUp=Backbone.View.extend({parent:$("body"),id:"popup-container",className:"abs",template:function(){return _.template(PulseApp.Templates.PopUp,{})},events:{"click #mask":"remove"},initialize:function(b,a){if(a){for(key in a){this[key]=a[key]}}this.render()},render:function(){this.$el.append(this.template);if(this.page){var b=this.page;this.$el.css("top",b.y-this.$el.height()/2).css("left",b.x-this.$el.width()/2)}var a=this.$el.find("ul");_.each(this.model,function(c){a.append(new PulseApp.Views.AddPagePopUpItem({model:c},{catalogItem:this.catalogItem,addButton:this.addButton,parentView:this,type:this.type}).$el)},this);if(this.model.length<50){a.append(new PulseApp.Views.AddNewPagePopUp({},{catalogItem:this.catalogItem,addButton:this.addButton,parentView:this,type:this.type}).$el)}return this},remove:function(){var a=this;this.$el.find("#mask").hide();this.$el.find("#popup").removeClass("loaded");setTimeout(function(){Backbone.View.prototype.remove.call(a)},800)}});PulseApp.Views.AddNewPagePopUp=Backbone.View.extend({tagName:"li",className:"popup-item add-new",events:{click:"addPage","keydown :input":"logKey"},initialize:function(b,a){_.bindAll(this,"addNewPage","pageSelected","validatePageName");this.catalogItem=a.catalogItem;this.parentView=a.parentView;this.addButton=a.addButton;this.type=a.type;this.render()},addPage:function(){this.$el.unbind("click").addClass("open");this.$el.html("<input type='text' id='new-page-name' class='border-box'></input><input type='button' value='Add' id='add-new-page'></input>");this.page_list=this.$el.parent();this.page_list.scrollTop(this.page_list[0].scrollHeight);this.$el.find("#new-page-name").focus();$("#add-new-page").click(this.validatePageName)},addNewPage:function(a){this.page_position=PulseApp.UserPages.models.length;var b=new PulseApp.User.Models.Page({page_title:a,page_position:this.page_position});PulseApp.UserPages.add(b);this.$el.html(unescape(a));this.pageSelected();this.parentView.remove()},validatePageName:function(){var b=this.$el.find("#new-page-name").val(),d=this.page_list,a=30,c;c=PulseApp.Helpers.validatePageName(b);this.$el.find(".add-page-error").remove();if(c===""){this.addNewPage(b)}else{this.$el.append('<p class="add-page-error">'+c+"</p>")}d.scrollTop(d[0].scrollHeight)},render:function(){this.$el.append("New Page");return this},pageSelected:function(){this.catalogItem.set({is_added:true});PulseApp.Helpers.markDuplicatesInCatalog(this.catalogItem);PulseApp.UserPages.addSourceToPage(this.page_position,this.catalogItem);PulseApp.LoggingHelper.addedSource(this.catalogItem,this.type);$(this.addButton).toggleClass("added")},logKey:function(a){if(a.keyCode===13){this.validatePageName()}}});PulseApp.Views.AddPagePopUpItem=Backbone.View.extend({tagName:"li",className:"popup-item ellipsis",events:{click:"pageSelected"},template:function(a){return _.template(PulseApp.Templates.AddPagePopUpItem,{data:a})},initialize:function(b,a){this.catalogItem=a.catalogItem;this.parentView=a.parentView;this.addButton=a.addButton;this.type=a.type;this.render()},render:function(){this.$el.append(unescape(this.model.get("page_title").toLowerCase()));if(this.model.get("page_sources").length>=12){this.$el.addClass("full")}return this},pageSelected:function(){if(this.model.get("page_sources").length>=12){return this}else{this.unbind("click");$(this.addButton).addClass("added");this.catalogItem.set({is_added:true});PulseApp.Helpers.markDuplicatesInCatalog(this.catalogItem);PulseApp.UserPages.addSourceToPage(this.model.get("page_position"),this.catalogItem);PulseApp.LoggingHelper.addedSource(this.catalogItem,this.type);this.parentView.remove()}return this}});PulseApp.Views.CatalogResultRow=Backbone.View.extend({tagName:"li",className:"catalog_item clear",events:{"click .add-button":"addSource"},template:function(a){return _.template(PulseApp.Templates.CatalogListItem,{data:a})},render:function(){this.$el.append(this.template(this.model.toJSON()));this.$el.find(".external-icon").error(function(){$(this).closest(".external-icon-container").css({display:"none"})});return this},addSource:function(c){if(PulseApp.Environment.isLoggedInUser()){var a,b=this;if(this.model.get("is_added")){return}else{a=new PulseApp.Views.AddPagePopUp({model:PulseApp.UserPages.models},{catalogItem:this.model,addButton:c.target,type:"search"});this.$el.append(a.$el);setTimeout(function(){b.$el.find("#popup").addClass("loaded")},10);return this}}else{PulseApp.Helpers.createSignUpModal("Read "+this.model.get("domain"),"Sign up easily to add your favorite sources.","add_source")}}});PulseApp.Views.CatalogResults=Backbone.View.extend({tagName:"ul",className:"search-results",initialize:function(){this.render()},render:function(){_.each(this.collection.models,function(a){this.$el.append(new PulseApp.Views.CatalogResultRow({model:a}).render().el)},this);return this}});PulseApp.Views.CatalogSearch=Backbone.View.extend({parent:"#catalog-right",id:"search-results",className:"abs border-box",initialize:function(a){this.parentView=a.parentView;this.collection.bind("reset",this.render,this);$(this.parent).prepend(this.$el)},render:function(){this.$el.empty();if(this.collection.search_results_collection.length===0){this.catalogSearchComplete()}else{this.$el.append(new PulseApp.Views.CatalogResults({collection:this.collection.search_results_collection}).el);this.catalogSearchComplete()}},updateKeyword:function(a){this.collection.updateKeyword(a)},catalogSearchComplete:function(){$("#catalog-content .throbber").hide();this.parentView.fireCatalogServiceSearch({keyword:this.collection.keyword})}});PulseApp.Views.CatalogServiceSearch=Backbone.View.extend({parent:"#search-results",tagName:"ul",className:"search-results",initialize:function(a){this.isLastCollection=a.isLastCollection;this.parentView=a.parentView;this.collection.bind("reset",this.render,this)},render:function(){if(this.collection.search_results_collection.length){this.$el.append('<h3 class="catalog-service-title">'+this.collection.title+"</h3>");_.each(this.collection.search_results_collection.models,function(a){this.$el.append(new PulseApp.Views.CatalogResultRow({model:a}).render().el)},this);$(this.parent).append(this.$el);if(this.isLastCollection){this.parentView.searchComplete()}return this}}});